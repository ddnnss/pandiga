{% extends 'basic.html' %}
{% load static %}
{% block content %}
    <div class="main">
        <div class="container">
            <div class="breadcrumbs">
                <ul>
                    <li><a href="/">главная</a></li>
                    <li>заявка на технику</li>
                </ul>
            </div><!--//breadcrumbs-->
        </div><!--//container-->

        <section class="technique-form">
            <div class="container">
                <div class="section-header"><h1>заявка на технику</h1></div>
                <p class="text-center mb-30">Вы можете создать заявку на поиск техники и владельцы техники сами откликнуться на нее</p>

                {% if messages %}
                    {% for message in messages %}
                        {{ message.tags }}
                        {% if message.tags %}  <div style="margin-bottom: 10px; color: green;">{% endif %} <strong> {{ message }}</strong>   </div>
                    {% endfor %}
                {% endif %}

                <form action="{% url 'technique_order' %}" method="post" enctype="multipart/form-data">{% csrf_token %}
                    <div class="form-row">
                        <label for="">название</label>
                        <input type="text" required name="{{ form.name.name}}">
                    </div><!--//form-row-->



                    <div class="form-row">
                        <label for="">тип</label>
                        <select id="type_select" required >
                            <option selected disabled>Выбрать</option>
                            {% for type in all_types %}
                                <option value="{{ type.name_slug }}">{{ type.name | capfirst }}</option>
                            {% endfor %}

                        </select>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">раздел</label>
                        <select id="section_select" required >
                            <option disabled selected class="section-name" >Выберите тип</option>

                        </select>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">подраздел</label>
                        <select id="subsection_select" required name="{{ form.sub_section.name }}">
                            <option disabled selected class="subsection-name" >Выберите раздел</option>
                        </select>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">Срок аренды</label>
                        <div class="form-row-group">
                            <input type="number" min="1" required name="{{ form.rent_time.name }}">
                            <select name="{{ form.rent_type.name }}"  >
                                <option selected value="hour" data-label="час">Часов</option>
                                <option value="day" data-label="день">Дней</option>
                            </select>
                        </div>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">Когда</label>
                        <div style="grid-template-columns: 2fr 1fr 2fr; align-items: center" class="form-row-group">
                            <input type="date" name="{{ form.order_date.name }}">
                              <label class="custom-checkbox">На точное время
                                    <input type="checkbox" id="order_time_check" name="order_time_check" onchange="toggleTime(this)">
                                    <span class="checkmark"></span>
                                </label>
                            <input class="not-visible" id="order_time" disabled type="time" name="{{ form.order_time.name }}">
                        </div>


                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">местоположение</label>
                        <div class="city-select">
                            <input autocomplete="off" required id="city_select_input" class="city-select-input" onkeyup="getCities(this)" type="text">
                            <div id="city_select_list" class="city-select-list ">

                            </div>
                        </div>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">Комментарий</label>
                        <textarea name="{{ form.comment.name }}"  cols="30" rows="10"></textarea>

                    </div><!--//form-row-->




                    <input id="city_id" type="hidden" name="{{ form.city.name }}" value="0">
                    {% if request.user.is_authenticated %}
                        <button type="submit" class="btn btn-link by-center">Создать заявку</button>
                    {% else %}
                        <span class="btn btn-link by-center" onclick="openModal()">Создать заявку</span>
                    {% endif %}
                </form>

            </div><!--//container-->

        </section><!--//main-catalog-->

    </div><!--//main-->
    {% if not request.user.is_authenticated %}
        <div id="openModal" class="modal">
            <div id="modal_login" class="modal-dialog " >
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title section-header">Ошибка</h3>
                        <a href="#close" title="Close" onclick="openModal()" class="close">×</a>
                    </div>
                    <div  class="modal-body">
                        <p class="modal-error-text">Необходима регистрация</p>
                        <a href="{% url 'login_page' %}" class="btn btn-link by-center mb-20" >закрыть</a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}
{% block js %}
    {{ block.super }}
    <!-- preview images-->
    <script>
        let timeInput = document.getElementById('order_time')
        function toggleTime(el) {
            timeInput.value=''
            timeInput.classList.toggle('not-visible')
            if (el.checked){

               timeInput.removeAttribute('disabled')
            }
            else{
                timeInput.setAttribute('disabled','disabled')
            }
        }
        function previewImages() {
            var preview = document.querySelector('#preview');
            preview.innerHTML = ''
            if (this.files) {
                [].forEach.call(this.files, readAndPreview);
            }
            function readAndPreview(file) {
                var reader = new FileReader();
                reader.addEventListener("load", function() {
                    var image = new Image();
                    image.height = 140;
                    image.width = 140;
                    image.title  = file.name;
                    image.src    = this.result;
                    preview.appendChild(image);
                    // image.addEventListener("click", event => {
                    //      console.log(file.name)
                    //       console.log(allImages.files)
                    //})
                });
                reader.readAsDataURL(file);
            }
        }
        document.querySelector('#upload_img').addEventListener("change", previewImages);
    </script>
    <!-- preview images-->
    <!-- get section && subsection-->
    <script>
        let typeSelect = document.getElementById('type_select')
        let sectionSelect = document.getElementById('section_select')
        let subsectionSelect = document.getElementById('subsection_select')

        function clearSelect(el){
            let elem = document.querySelectorAll(`.${el}`)
            elem.forEach(function (i) {
                console.log('Elem to clear:',i)
                i.remove()
            })
        }

        function createOption(name_slug,name,target,ro) {
            let option = document.createElement("option")
            option.text = name
            option.value = name_slug
            if (ro){
                option.setAttribute('disabled','disabled')
                option.setAttribute('selected','selected')
            }
            option.classList.add(`${target}-name`)
            return option

        }
        function getSubcat(name_slug,target) {
            let body = {'type':name_slug,'target':target}
            fetch('/catalog/get_type_sublists/', {
                method: 'post',
                body: JSON.stringify(body),
                headers: { "X-CSRFToken": csrfmiddlewaretoken },
                credentials: 'same-origin'
            }).then(res=>res.json())
                .then(res => {
                    console.log(res)
                    if (target === 'section'){
                        sectionSelect.appendChild(createOption('all','Выберите раздел',target))
                        for (x of res) {
                            //console.log(x['id'])
                            sectionSelect.appendChild(createOption(x['name_slug'],x['name'],target))
                        }
                    }
                    if (target === 'subsection'){
                        subsectionSelect.appendChild(createOption('all','Выберите подраздел',target))
                        for (x of res) {
                            //console.log(x['id'])
                            subsectionSelect.appendChild(createOption(x['id'],x['name'],target))
                        }
                    }
                })
        }

        typeSelect.addEventListener('change',()=>{
            clearSelect('section-name')
            clearSelect('subsection-name')
            getSubcat(typeSelect.options[typeSelect.selectedIndex].value,'section')

        })
        sectionSelect.addEventListener('change',()=>{
            clearSelect('subsection-name')
            getSubcat(sectionSelect.options[sectionSelect.selectedIndex].value,'subsection')
        })
    </script>
    <!-- //get section && subsection-->


{% endblock %}