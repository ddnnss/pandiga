{% extends 'basic.html' %}
{% load static %}
{% block content %}
    <div class="main">
        <div class="container">
            <div class="breadcrumbs">
                <ul>
                    <li><a href="/">главная</a></li>
                    <li>добавить технику в каталог</li>
                </ul>
            </div><!--//breadcrumbs-->
        </div><!--//container-->

        <section class="technique-form">
            <div class="container">
                <div class="section-header"><h1>добавить технику в каталог</h1></div>
                <p class="text-center mb-30">Добавьте свою технику в базу клуба и начинайте зарабатывать уже сегодня.<br> Для этого заполните форму ниже, отредактировать информацию или удалить свою технику вы сможете в любое время.</p>

                {% if messages %}
                    {% for message in messages %}
                        {{ message.tags }}
                        {% if message.tags %}  <div style="margin-bottom: 10px; color: green;">{% endif %} <strong> {{ message }}</strong>   </div>
                    {% endfor %}
                {% endif %}

                <form action="{% url 'add_technique' %}" method="post" enctype="multipart/form-data">{% csrf_token %}
                    <div class="form-row">
                        <label for="">название</label>
                        <input type="text" required name="{{ form.name.name}}">
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">местоположение</label>
                        <div class="city-select">
                            <input autocomplete="off" required id="city_select_input" placeholder="Начните вводить город" class="city-select-input" onkeyup="getCities(this)" type="text">
                            <div id="city_select_list" class="city-select-list ">

                            </div>
                        </div>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">фотографии</label>
                        <div class="upload-wrapper">
                            {#                            <label for="upload_img" class="upload-label">#}
                            <input id="upload_img" required multiple name="item_images" accept="image/*"  type="file" >
                            {#                            </label>#}
                            <div id="preview" class="images-preview"></div>
                        </div>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">тип</label>
                        <select id="type_select" required >
                            <option selected disabled>Выбрать</option>
                            {% for type in all_types %}
                                <option value="{{ type.name_slug }}">{{ type.name | capfirst }}</option>
                            {% endfor %}

                        </select>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">раздел</label>
                        <select id="section_select" required >
                            <option disabled selected class="section-name" >Выберите тип</option>

                        </select>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">подраздел</label>
                        <select id="subsection_select" required name="{{ form.sub_section.name }}">
                            <option disabled selected class="subsection-name" >Выберите раздел</option>
                        </select>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">минимальное время аренды</label>
                        <div class="form-row-group">
                            <input id="rent_time_input" type="number" min="1" max="24" required name="{{ form.min_rent_time.name }}">
                            <select name="{{ form.rent_type.name }}" id="" onchange="changePrice(this)" >
                                <option selected value="hour" data-label="час" data-time="24">Часов</option>
                                <option value="day" data-label="день" data-time="30">Дней</option>
                            </select>
                        </div>

                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">стоимость (руб)</label>
                        <div  class="form-row-group">
                            <input type="number" min="1" required name="{{ form.rent_price.name }}">
                            <p  style="align-self: center;font-size: 20px">/ <span id="price_label">час</span></p>

                        </div>

                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">описание</label>
                        <textarea required name="{{ form.description.name }}"  cols="30" rows="10"></textarea>

                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">характеристики</label>
                        <textarea required name="{{ form.features.name }}"  cols="30" rows="10"></textarea>

                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">Документы</label>

                        <input  multiple name="item_docs" accept="image/*"  type="file" >


                    </div><!--//form-row-->
                    <input id="city_id" type="hidden" name="{{ form.city.name }}" value="0">

                    {% if request.user.is_authenticated %}
                        {% if can_add_technique %}

                            {% if profile_ok %}
                                <button type="submit" class="btn btn-link by-center">добавить технику</button>
                            {% else %}
                                <p class="text-center mb-20">Ваш профиль не заполнен</p>
                                <a class="btn btn-link by-center" href="{% url 'lk_page' %}?tab=tab-profile">Заполнить профиль</a>
                            {% endif %}

                        {% else %}

                            <p class="text-center mb-20">Вам доступно добавление {{ my_tarif.technique_count }} ед. техники.</p>
                            <a class="btn btn-link by-center" href="{% url 'lk_page' %}?tab=tab-tarif">Изменить тариф</a>

                        {% endif %}

                    {% else %}

                        <span class="btn btn-link by-center" onclick="openModal()">добавить технику</span>

                    {% endif %}
                </form>

            </div><!--//container-->

        </section><!--//main-catalog-->

    </div><!--//main-->
    {% if not request.user.is_authenticated %}
        <div id="openModal" class="modal">
            <div id="modal_login" class="modal-dialog " >
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title section-header">Ошибка</h3>
                        <a href="#close" title="Close" onclick="openModal()" class="close">×</a>
                    </div>
                    <div  class="modal-body">
                        <p class="modal-error-text">Необходима регистрация</p>
                        <a href="{% url 'login_page' %}" class="btn btn-link by-center mb-20" >закрыть</a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}
{% block js %}
    {{ block.super }}
    <!-- preview images-->
    <script src="https://cdn.ckeditor.com/4.14.0/basic/ckeditor.js"></script>
     <script>
          CKEDITOR.replace( '{{ form.description.name }}' );
          CKEDITOR.replace( '{{ form.features.name }}' );
     </script>
    <script>
        let priceLabel = document.getElementById('price_label')
        let rentTimeInput = document.getElementById('rent_time_input')
        function changePrice(el) {
            let selectedVal = el.options[el.selectedIndex]
            priceLabel.innerText = selectedVal.dataset.label
            rentTimeInput.setAttribute('max',selectedVal.dataset.time)

        }
        function previewImages() {
            var preview = document.querySelector('#preview');
            preview.innerHTML = ''
            if (this.files) {
                [].forEach.call(this.files, readAndPreview);
            }
            function readAndPreview(file) {
                var reader = new FileReader();
                reader.addEventListener("load", function() {
                    var image = new Image();
                    image.height = 140;
                    image.width = 140;
                    image.title  = file.name;
                    image.src    = this.result;
                    preview.appendChild(image);
                    // image.addEventListener("click", event => {
                    //      console.log(file.name)
                    //       console.log(allImages.files)
                    //})
                });
                reader.readAsDataURL(file);
            }
        }
        document.querySelector('#upload_img').addEventListener("change", previewImages);
    </script>
    <!-- preview images-->
    <!-- get section && subsection-->
    <script>
        let typeSelect = document.getElementById('type_select')
        let sectionSelect = document.getElementById('section_select')
        let subsectionSelect = document.getElementById('subsection_select')

        function clearSelect(el){
            let elem = document.querySelectorAll(`.${el}`)
            elem.forEach(function (i) {
                console.log('Elem to clear:',i)
                i.remove()
            })
        }

        function createOption(name_slug,name,target,ro) {
            let option = document.createElement("option")
            option.text = name
            option.value = name_slug
            if (ro){
                option.setAttribute('disabled','disabled')
                option.setAttribute('selected','selected')
            }
            option.classList.add(`${target}-name`)
            return option

        }
        function getSubcat(name_slug,target) {
            let body = {'type':name_slug,'target':target}
            fetch('/catalog/get_type_sublists/', {
                method: 'post',
                body: JSON.stringify(body),
                headers: { "X-CSRFToken": csrfmiddlewaretoken },
                credentials: 'same-origin'
            }).then(res=>res.json())
                .then(res => {
                    console.log(res)
                    if (target === 'section'){
                        sectionSelect.appendChild(createOption('all','Выберите раздел',target))
                        for (x of res) {
                            //console.log(x['id'])
                            sectionSelect.appendChild(createOption(x['name_slug'],x['name'],target))
                        }
                    }
                    if (target === 'subsection'){
                        subsectionSelect.appendChild(createOption('all','Выберите подраздел',target))
                        for (x of res) {
                            //console.log(x['id'])
                            subsectionSelect.appendChild(createOption(x['id'],x['name'],target))
                        }
                    }
                })
        }

        typeSelect.addEventListener('change',()=>{
            clearSelect('section-name')
            clearSelect('subsection-name')
            getSubcat(typeSelect.options[typeSelect.selectedIndex].value,'section')

        })
        sectionSelect.addEventListener('change',()=>{
            clearSelect('subsection-name')
            getSubcat(sectionSelect.options[sectionSelect.selectedIndex].value,'subsection')
        })
    </script>
    <!-- //get section && subsection-->


{% endblock %}