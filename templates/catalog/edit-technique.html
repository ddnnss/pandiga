{% extends 'basic.html' %}
{% load static %}
{% block content %}
    <div class="main">
        <div class="container">
            <div class="breadcrumbs">
                <ul>
                    <li><a href="/">главная</a></li>
                    <li>редактирование техники</li>
                </ul>
            </div><!--//breadcrumbs-->
        </div><!--//container-->

        <section class="technique-form">
            <div class="container">
                <div class="section-header"><h1>редактирование техники</h1></div>

                {% if messages %}
                    {% for message in messages %}
                        {{ message.tags }}
                        {% if message.tags %}  <div style="margin-bottom: 10px; color: green;">{% endif %} <strong> {{ message }}</strong>   </div>
                    {% endfor %}
                {% endif %}

                <form action="{% url 'updateTechnique' %}" method="post" enctype="multipart/form-data">{% csrf_token %}
                    <div class="form-row">
                        <label for="">название</label>
                        <input type="text" required name="{{ form.name.name}}" value="{{ techniqueItem.name }}">
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">местоположение</label>
                        <div class="city-select">
                            <input autocomplete="off" required id="city_select_input" placeholder="Начните вводить город"
                                   class="city-select-input" onkeyup="getCities(this)" onfocus="this.value = ''"
                                   type="text" value="{{ techniqueItem.city.region }}, {{ techniqueItem.city.city }}">
                            <div id="city_select_list" class="city-select-list ">

                            </div>
                        </div>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">фотографии</label>
                        <div class="upload-wrapper">
                            {#                            <label for="upload_img" class="upload-label">#}
                            <input style="border: none;
    background: none;" id="upload_img"  multiple name="item_images" accept="image/*"  type="file" >
                            {#                            </label>#}
                            <div id="preview" class="images-preview">
                                 {% for image in techniqueItem.images.all %}
                                        <img style="width: 140px; height: 140px; object-fit: cover;" src="{{ image.image.url }}">
                                    {% endfor %}
                            </div>
                        </div>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">тип</label>
                        <select id="type_select" required >

                            {% for type in all_types %}
                                <option {% if techniqueItem.type.id == type.id %}selected{% endif %} value="{{ type.name_slug }}">{{ type.name | capfirst }}</option>
                            {% endfor %}

                        </select>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">раздел</label>
                        <select id="section_select" required >

                            {% for subtype in techniqueItem.type.sections.all %}

                                 <option {% if techniqueItem.section.id == subtype.id %}selected{% endif %}
                                         {% if techniqueItem.section.id == subtype.id %}value="{{ techniqueItem.section.name_slug }}"{% else %}value="{{ subtype.name_slug }}"{% endif %}

                                         class="section-name" >{{ subtype.name }}</option>
                            {% endfor %}
                        </select>
                    </div><!--//form-row-->

                    <div class="form-row">
                        <label for="">подраздел</label>
                        <select id="subsection_select" required name="{{ form.sub_section.name }}">

                            {% for subsection in techniqueItem.section.subsections.all %}
                                 <option {% if techniqueItem.sub_section.id == subsection.id %}selected{% endif %}
                                         {% if techniqueItem.sub_section.id == subsection.id %}value="{{ techniqueItem.sub_section.id }}"{% else %}value="{{ subsection.id }}"{% endif %}
                                         class="subsection-name" >{{ subsection.name }}</option>
                            {% endfor %}
                        </select>
                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">минимальное время аренды</label>
                        <div class="form-row-group">
                            <input id="rent_time_input" type="number" min="1" max="24" required name="{{ form.min_rent_time.name }}" value="{{ techniqueItem.min_rent_time }}">
                            <select name="{{ form.rent_type.name }}" id="" onchange="changePrice(this)" >
                                <option {% if techniqueItem.rent_type == 'hour' %}selected{% endif %} value="hour" data-label="час" data-time="24">Часов</option>
                                <option {% if techniqueItem.rent_type == 'day' %}selected{% endif %} value="day" data-label="день" data-time="30">Дней</option>
                            </select>
                        </div>

                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">стоимость (руб)</label>
                        <div  class="form-row-group">
                            <input type="number" min="1" required name="{{ form.rent_price.name }}" value="{{ techniqueItem.rent_price }}">
                            <p  style="align-self: center;font-size: 20px">/ <span id="price_label">{% if techniqueItem.rent_type == 'hour' %}час{% else %}день{% endif %}</span></p>

                        </div>

                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">описание</label>
                        <textarea required name="{{ form.description.name }}"  cols="30" rows="10">{{ techniqueItem.description }}</textarea>

                    </div><!--//form-row-->
                    <div class="form-row">
                        <label for="">характеристики</label>
                        <textarea required name="{{ form.features.name }}"  cols="30" rows="10">{{ techniqueItem.features }}</textarea>

                    </div><!--//form-row-->

                    <input id="city_id" type="hidden" name="{{ form.city.name }}" value="{{ techniqueItem.city.id }}">


                         <input type="hidden" name="item_id" value="{{ techniqueItem.id }}">
                          <button type="submit" class="btn btn-link by-center">Сохранить изменения</button>
                </form>

            </div><!--//container-->

        </section><!--//main-catalog-->

    </div><!--//main-->

{% endblock %}
{% block js %}
    {{ block.super }}
    <!-- preview images-->
     <script src="https://cdn.ckeditor.com/4.14.0/basic/ckeditor.js"></script>
     <script>
          CKEDITOR.replace( '{{ form.description.name }}' );
          CKEDITOR.replace( '{{ form.features.name }}' );
     </script>
    <script>

        let priceLabel = document.getElementById('price_label')
        let rentTimeInput = document.getElementById('rent_time_input')
        function changePrice(el) {
            let selectedVal = el.options[el.selectedIndex]
            priceLabel.innerText = selectedVal.dataset.label
            rentTimeInput.setAttribute('max',selectedVal.dataset.time)

        }
        function previewImages() {
            var preview = document.querySelector('#preview');
            preview.innerHTML = ''
            if (this.files) {
                [].forEach.call(this.files, readAndPreview);
            }
            function readAndPreview(file) {
                var reader = new FileReader();
                reader.addEventListener("load", function() {
                    var image = new Image();
                    image.height = 140;
                    image.width = 140;
                    image.title  = file.name;
                    image.src    = this.result;
                    preview.appendChild(image);
                    // image.addEventListener("click", event => {
                    //      console.log(file.name)
                    //       console.log(allImages.files)
                    //})
                });
                reader.readAsDataURL(file);
            }
        }
        document.querySelector('#upload_img').addEventListener("change", previewImages);
    </script>
    <!-- preview images-->
    <!-- get section && subsection-->
    <script>
        let typeSelect = document.getElementById('type_select')
        let sectionSelect = document.getElementById('section_select')
        let subsectionSelect = document.getElementById('subsection_select')

        function clearSelect(el){
            let elem = document.querySelectorAll(`.${el}`)
            elem.forEach(function (i) {
                console.log('Elem to clear:',i)
                i.remove()
            })
        }

        function createOption(name_slug,name,target,ro) {
            let option = document.createElement("option")
            option.text = name
            option.value = name_slug
            if (ro){
                option.setAttribute('disabled','disabled')
                option.setAttribute('selected','selected')
            }
            option.classList.add(`${target}-name`)
            return option

        }
        function getSubcat(name_slug,target) {
            let body = {'type':name_slug,'target':target}
            fetch('/catalog/get_type_sublists/', {
                method: 'post',
                body: JSON.stringify(body),
                headers: { "X-CSRFToken": csrfmiddlewaretoken },
                credentials: 'same-origin'
            }).then(res=>res.json())
                .then(res => {
                    console.log(res)
                    if (target === 'section'){
                        sectionSelect.appendChild(createOption('all','Выберите раздел',target))
                        for (x of res) {
                            //console.log(x['id'])
                            sectionSelect.appendChild(createOption(x['name_slug'],x['name'],target))
                        }
                    }
                    if (target === 'subsection'){
                        subsectionSelect.appendChild(createOption('all','Выберите подраздел',target))
                        for (x of res) {
                            //console.log(x['id'])
                            subsectionSelect.appendChild(createOption(x['id'],x['name'],target))
                        }
                    }
                })
        }

        typeSelect.addEventListener('change',()=>{
            clearSelect('section-name')
            clearSelect('subsection-name')
            getSubcat(typeSelect.options[typeSelect.selectedIndex].value,'section')

        })
        sectionSelect.addEventListener('change',()=>{
            clearSelect('subsection-name')
            getSubcat(sectionSelect.options[sectionSelect.selectedIndex].value,'subsection')
        })
    </script>
    <!-- //get section && subsection-->


{% endblock %}