{% extends 'basic.html' %}
{% load static %}
{% block content %}
    <div class="main">
        <div class="container">
            <div class="breadcrumbs">
                <ul>
                    <li><a href="/">главная</a></li>
                    <li><a href="{% url 'technique_catalog' %}">каталог техники</a></li>

                    {% if current_technique_section and not current_technique_subsection%}
                        <li><a href="{% url 'technique_type_catalog' current_technique_type.name_slug %}">{{ current_technique_type.name }}</a></li>
                        <li>{{ current_technique_section.name }}</li>
                    {% elif current_technique_subsection%}
                        <li><a href="{% url 'technique_type_catalog' current_technique_type.name_slug %}">{{ current_technique_type.name }}</a></li>
                        <li><a href="{% url 'technique_section_catalog' current_technique_type.name_slug current_technique_section.name_slug %}">{{ current_technique_section.name }}</a></li>
                        <li>{{ current_technique_subsection.name }}</li>
                    {% else %}
                        <li>{{ current_technique_type.name }}</li>
                    {% endif %}
                </ul>
            </div><!--//breadcrumbs-->


            <section class="items-block">
                <div class="section-header"><h1>название категории</h1></div>
                <div class="items-block-wrapper">
                    <div class="items-block-left">
                        <div class="category-menu mb-10">
                            <ul class="category-menu-wrapper">
                                {% for type in all_technique_types %}
                                    <li class="category-menu-item" ><a {% if current_technique_type.id == type.id%}
                                        class="menu-item-active"
                                    {% endif %}
                                        href="{% url 'technique_type_catalog' type.name_slug %}">{{ type.name }}</a>
                                        <div  class="category-menu-inner">
                                            <ul class="category-menu-inner-wrapper">
                                                {% for section in type.sections.all %}
                                                    <li class="category-menu-inner-item">
                                                        <a {% if current_technique_section.id == section.id%}
                                                            class="menu-item-active"
                                                        {% endif %}
                                                            href="{% url 'technique_section_catalog' current_technique_type.name_slug section.name_slug%}">
                                                            {{ section.name }}
                                                        </a>
                                                        <div  class="category-menu-inner">
                                                            <ul class="category-menu-inner-wrapper">
                                                                {% for subsection in section.subsections.all %}
                                                                    <li class="category-menu-item link-item">
                                                                        <a {% if current_technique_subsection.id == subsection.id%}
                                                                            class="menu-item-active"
                                                                        {% endif %}
                                                                            href="{% url 'technique_subsection_catalog' current_technique_type.name_slug section.name_slug subsection.name_slug%}">
                                                                            {{ subsection.name }}
                                                                        </a>
                                                                    </li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    </li>
                                                {% endfor %}

                                            </ul>
                                        </div>
                                    </li>
                                {% endfor %}

                            </ul>
                        </div>
                        <div class="item-filter">
                            <form id="filters_form" action="" method="get">
                                <p>Поиск по категории</p>
                                <input name="search" type="text" value="{% if filter_search %}{{ filter_search }}{% endif %}">
                                <p>География</p>
                                <div class="city-select">
                                    <input autocomplete="off" id="city_select_input" class="city-select-input" onkeyup="getCities(this)" type="text" value="{{ city_from_filter }}">
                                    <div id="city_select_list" class="city-select-list ">

                                    </div>
                                </div>
                                {#                            <p>Тип</p>#}
                                <select style="display: none" name="" id="type_select">
                                    <option value="any">Любой</option>
                                    {% for type in all_techique_types %}
                                        <option {% if current_technique_type.id == type.id%}selected{% endif %} value="{{ type.name_slug }}">{{ type.name }}</option>
                                    {% endfor %}

                                </select>
                                <p>Раздел</p>
                                <select name="section" id="section_select">
                                    <option value="all">Все разделы</option>
                                    {#                                    <option value="{% if filter_section  %}{{ section_name.name_slug }}{% else %}all{% endif %}">#}
                                    {#                                        {% if filter_section  %}{{ section_name.name }}{% else %}Все разделы{% endif %}</option>#}
                                    {% for section in current_technique_type.sections.all %}
                                        <option {% if current_technique_section.id == section.id or section_from_filter.id == section.id %}selected{% endif %} class="section-name" value="{{ section.name_slug }}">{{ section.name }}</option>
                                    {% endfor %}
                                </select>
                                <p>Подраздел</p>
                                <select name="subsection" id="subsection_select">
                                    <option value="all">Все подразделы</option>
                                    {% if current_technique_section %}
                                        {% for subsection in current_technique_section.subsections.all %}
                                            <option {% if current_technique_subsection.id == subsection.id or subsection_from_filter.id == subsection.id%}selected{% endif %} class="subsection-name" value="{{ subsection.name_slug }}">{{ subsection.name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                    {% if section_from_filter %}
                                        {% for subsection in section_from_filter.subsections.all %}
                                            <option {% if subsection_from_filter.id == subsection.id%}selected{% endif %} class="subsection-name" value="{{ subsection.name_slug }}">{{ subsection.name }}</option>
                                        {% endfor %}
                                    {% endif %}

                                </select>
                                <div class="hr"></div>
                                <label class="custom-checkbox">Фильтр по дням

                                    <input type="checkbox" id="time_type" name="time_type" {% if  filter_time_type %}checked{% endif %} onchange="toggleTimeFilter(this)">
                                    <span class="checkmark"></span>
                                </label>
                                <div class="hr"></div>
                                <div id="horly" class="mb-20 {% if  filter_time_type  %}not-visible{% endif %}">
                                    <p>Время аренды (часы)</p>

                                    <div class="dual-input">
                                        <input id="h_from" {% if  filter_time_type  %}disabled{% endif %} name="h_from"  type="text"  placeholder="От"
                                               value="{% if filter_h_from %}{{ filter_h_from }}{% endif %}">
                                        <p>-</p>
                                        <input id="h_to" {% if  filter_time_type  %}disabled{% endif %} name="h_to" type="text"  placeholder="До"
                                        value="{% if filter_h_to %}{{ filter_h_to }}{% endif %}">
                                    </div>
                                    <div id="slider_h" class="range-input"></div>
                                    <p class="filter-caption ">Стоимость <i class="fa fa-rub"></i> / час</p>
                                    <div class="dual-input">
                                        <input id="price_from" {% if  filter_time_type  %}disabled{% endif %} name="h_price_from" type="text"  placeholder="От">
                                        <p>-</p>
                                        <input id="price_to" {% if  filter_time_type  %}disabled{% endif %}  name="h_price_to" type="text"  placeholder="До">
                                    </div>
                                    <div id="slider" class="range-input "></div>
                                </div>

                                <div id="daily" class="mb-20 {% if not filter_time_type %}not-visible{% endif %}">
                                    <p>Время аренды (дни)</p>
                                    <div class="dual-input">
                                        <input id="d_from" {% if not filter_time_type  %}disabled{% endif %} name="d_from" type="text"  placeholder="От">
                                        <p>-</p>
                                        <input id="d_to" {% if not filter_time_type  %}disabled{% endif %} name="d_to" type="text"  placeholder="До">
                                    </div>
                                    <div id="slider_d" class="range-input"></div>
                                    <p class="filter-caption ">Стоимость <i class="fa fa-rub"></i> / день</p>
                                    <div class="dual-input">
                                        <input id="price_from_d" {% if not filter_time_type  %}disabled{% endif %} name="d_price_from" type="text"  placeholder="От">
                                        <p>-</p>
                                        <input id="price_to_d"  {% if not filter_time_type  %}disabled{% endif %} name="d_price_to" type="text"  placeholder="До">
                                    </div>
                                    <div id="slider_price_d" class="range-input "></div>
                                </div>


                                <input id="city_id" type="hidden" name="city" value="{% if filter_city  %}{{ filter_city }}{% else %}all{% endif %}">
                                <button type="submit" class="btn mb-10">поиск</button>
                            <span onclick="clearForm()" class="btn btn-outline btn-link">Сбросить фильтры</span>
                            </form>


                        </div>

                    </div><!--//items-block-left-->
                    <div class="items-block-right">
                        <div class="items-block-right-sorting">
                            <div class="items-block-right-sorting-inner">
                                <div class="items-block-right-sorting-inner-display">
                                    <p>Вид отображения</p>
                                    <a class="selected-display" href=""><i class="fa fa-th"></i></a>
                                    <a href=""><i class="fa fa-list"></i></a>
                                </div>
                            </div>
                        </div><!--//items-block-right-sorting-->
                        <div class="items-block-right-wrapper">
                            {% for technique in all_technique %}
                                <div class="item-grid">
                                    <a href="{% url 'technique' technique.sub_section.section.type.name_slug technique.sub_section.section.name_slug technique.sub_section.name_slug technique.name_slug%}">
                                        <div class="item-image" style="background: url({{ technique.get_main_image }})">
                                            {% if technique.is_free %}
                                                <span  class="item-free">свободен</span>
                                            {% else %}
                                                <span  class="item-busy">занят</span>
                                            {% endif %}
                                        </div>
                                        <div class="item-info">
                                            <div class="item-info-top">
                                                <div class="rating item-rating">
                                                    <p class="rating-value">{{ technique.rating }}</p>
                                                    <div class="rating-inner">
                                                        <ul class="rating-inner-stars">
                                                            {% for r in rating%}

                                                                <li class="rating-inner-star
                                                               {% if forloop.counter <= technique.rating %}star-colored{% endif %}">
                                                                    <i class="fa fa-star"></i></li>
                                                            {% endfor %}



                                                        </ul>
                                                    </div>
                                                </div>
                                                <div class="item-name">{{ technique.name }}</div>
                                            </div>
                                            <div class="item-info-bottom">
                                                <div class="item-info-user">
                                                    <div class="item-info-user-avatar"><img src="{{ technique.owner.get_avatar }}" alt=""></div>
                                                    <div class="item-info-user-name"><p>
                                                        {{ technique.owner.first_name }}
                                                        {% if  technique.owner.last_name %}
                                                            {{ technique.owner.last_name }}
                                                        {% endif %}
                                                    </p></div>
                                                </div>
                                                <div class="item-info-price">
                                                    <div class="item-info-price-time"><p class="item-info-price-time-value">от
                                                        <span>{{ technique.min_rent_time }}</span>
                                                        {% if technique.rent_type == 'hour' %}
                                                            Ч
                                                        {% elif technique.rent_type == 'day'%}
                                                            Д
                                                        {% endif %}
                                                    </p>
                                                    </div>
                                                    <div class="item-info-price-money"><p class="item-info-price-money-value">
                                                        <span>{{ technique.rent_price }}</span>
                                                        {% if technique.rent_type == 'hour' %}
                                                            <p>руб/час</p>
                                                        {% elif technique.rent_type == 'day'%}
                                                            <p>руб/день</p>
                                                        {% endif %}

                                                    </div>
                                                </div>
                                            </div>



                                        </div>
                                    </a>
                                </div><!--//item-grid-->
                            {% endfor %}

                        </div><!--//items-block-right-wrapper-->

                    </div><!--//items-block-right-->
                </div><!--//items-block-wrapper-->
                <div class="seo_text">
                    {{ seo_text | safe }}
                </div>
            </section><!--//items-->
        </div><!--//container-->
    </div><!--//main-->

{% endblock %}
{% block js %}
    {{ block.super }}
    <script src="{% static 'js/nouislider.js' %}"></script>
    <script>
        let slider_price = document.getElementById('slider');
        let slider_h = document.getElementById('slider_h');
        let slider_d = document.getElementById('slider_d');
        let slider_price_d = document.getElementById('slider_price_d');
        let priceValues = [
            document.getElementById('price_from'),
            document.getElementById('price_to')
        ];
        let hValues = [
            document.getElementById('h_from'),
            document.getElementById('h_to')
        ];

        let dValues = [
            document.getElementById('d_from'),
            document.getElementById('d_to')
        ];

        let dPriceValues = [
            document.getElementById('price_from_d'),
            document.getElementById('price_to_d')
        ];

        function toggleTimeFilter(el) {
            let horlyBlock = document.getElementById('horly')
            let dailyBlock = document.getElementById('daily')
            horlyBlock.classList.toggle('not-visible')
            dailyBlock.classList.toggle('not-visible')
            if (el.checked){

                 for (x in dValues){
                    hValues[x].setAttribute('disabled','disabled')
                }
                for (x in dPriceValues){
                    priceValues[x].setAttribute('disabled','disabled')
                }
                for (x in dValues){
                    dValues[x].removeAttribute('disabled')
                }
                for (x in dPriceValues){
                    dPriceValues[x].removeAttribute('disabled')
                }

            }
            else{
               for (x in dValues){
                    dValues[x].setAttribute('disabled','disabled')
                }
                for (x in dPriceValues){
                    dPriceValues[x].setAttribute('disabled','disabled')
                }
                for (x in dValues){
                    hValues[x].removeAttribute('disabled')
                }
                for (x in dPriceValues){
                    priceValues[x].removeAttribute('disabled')
                }
            }
        }

         function clearForm() {
            location.href = window.location.href.split('?')[0]


        }
    </script>
    <script>

        noUiSlider.create(slider_price, {
            start: [{% if filter_h_price_from %}{{ filter_h_price_from }}{% else %}0{% endif %},{% if filter_h_price_to %}{{ filter_h_price_to }}{% else %}10000{% endif %} ],
            connect: true,
            range: {
                'min': [0],

                'max': [10000]
            }

        });

        noUiSlider.create(slider_h, {
            start: [{% if filter_h_from %}{{ filter_h_from }}{% else %}0{% endif %},{% if filter_h_to %}{{ filter_h_to }}{% else %}24{% endif %} ],
            connect: true,
            range: {
                'min': [0],

                'max': [24]
            }

        });

        noUiSlider.create(slider_d, {
            start: [{% if filter_d_from %}{{ filter_d_from }}{% else %}0{% endif %},{% if filter_d_to %}{{ filter_d_to }}{% else %}30{% endif %}],
            connect: true,
            range: {
                'min': [0],

                'max': [30]
            }

        });

        noUiSlider.create(slider_price_d, {
            start: [{% if filter_d_price_from %}{{ filter_d_price_from }}{% else %}0{% endif %},{% if filter_d_price_to %}{{ filter_d_price_to }}{% else %}10000{% endif %}],
            connect: true,
            range: {
                'min': [0],

                'max': [10000]
            }

        });

        slider_price.noUiSlider.on('update', function (values, handle) {
            priceValues[handle].value = Math.floor(values[handle]);

        });
        priceValues[0].addEventListener('input', function () {
            slider_price.noUiSlider.set([this.value,null]);

        });
        priceValues[1].addEventListener('input', function () {
            slider_price.noUiSlider.set([null,this.value]);

        });


        slider_h.noUiSlider.on('update', function (values, handle) {
            hValues[handle].value = Math.floor(values[handle]);

        });
        hValues[0].addEventListener('input', function () {
            slider_h.noUiSlider.set([this.value,null]);

        });
        hValues[1].addEventListener('input', function () {
            slider_h.noUiSlider.set([null,this.value]);

        });


        slider_d.noUiSlider.on('update', function (values, handle) {
            dValues[handle].value = Math.floor(values[handle]);

        });
        dValues[0].addEventListener('input', function () {
            slider_d.noUiSlider.set([this.value,null]);

        });
        dValues[1].addEventListener('input', function () {
            slider_d.noUiSlider.set([null,this.value]);

        });

        slider_price_d.noUiSlider.on('update', function (values, handle) {
            dPriceValues[handle].value = Math.floor(values[handle]);

        });
        dPriceValues[0].addEventListener('input', function () {
            slider_price_d.noUiSlider.set([this.value,null]);

        });
        dPriceValues[1].addEventListener('input', function () {
            slider_price_d.noUiSlider.set([null,this.value]);

        });
    </script>
    <script>
        let acc = document.getElementsByClassName("accordion");
        let i;
        let lastActive = null
        let lastPanel = null

        for (i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                console.log(lastActive)
                if (lastActive){
                    lastActive.classList.remove('active')
                    lastPanel.classList.remove('panel-active')
                    lastPanel.style.maxHeight = null;
                }
                this.classList.toggle("active");
                lastActive=this
                let panel = this.nextElementSibling;
                lastPanel = panel
                if (panel.style.maxHeight) {

                    panel.style.maxHeight = null;
                    panel.classList.remove('panel-active')
                } else {
                    panel.style.maxHeight = panel.scrollHeight + "px";
                    panel.classList.add('panel-active')
                }
            });
        }
    </script>
        <!-- get section && subsection-->
    <script>
        let typeSelect = document.getElementById('type_select')
        let sectionSelect = document.getElementById('section_select')
        let subsectionSelect = document.getElementById('subsection_select')

        function clearSelect(el){
            let elem = document.querySelectorAll(`.${el}`)
            elem.forEach(function (i) {
                console.log('Elem to clear:',i)
                i.remove()
            })
        }

        function createOption(name_slug,name,target,ro) {
            let option = document.createElement("option")
            option.text = name
            option.value = name_slug
            if (ro){
                option.setAttribute('disabled','disabled')
                option.setAttribute('selected','selected')
            }
            option.classList.add(`${target}-name`)
            return option

        }
        function getSubcat(name_slug,target) {
            let body = {'type':name_slug,'target':target}
            fetch('/catalog/get_type_sublists/', {
                method: 'post',
                body: JSON.stringify(body),
                headers: { "X-CSRFToken": csrfmiddlewaretoken },
                credentials: 'same-origin'
            }).then(res=>res.json())
                .then(res => {
                    console.log(res)
                    if (target === 'section'){
                        //sectionSelect.appendChild(createOption('all','Выберите раздел',target))
                        for (x of res) {
                            //console.log(x['id'])
                            sectionSelect.appendChild(createOption(x['name_slug'],x['name'],target))
                        }
                    }
                    if (target === 'subsection'){
                        //subsectionSelect.appendChild(createOption('all','Выберите подраздел',target))
                        for (x of res) {
                            //console.log(x['id'])
                            subsectionSelect.appendChild(createOption(x['name_slug'],x['name'],target))
                        }
                    }
                })
        }

        typeSelect.addEventListener('change',()=>{
            clearSelect('section-name')
            clearSelect('subsection-name')
            getSubcat(typeSelect.options[typeSelect.selectedIndex].value,'section')

        })
        sectionSelect.addEventListener('change',()=>{
            clearSelect('subsection-name')
            getSubcat(sectionSelect.options[sectionSelect.selectedIndex].value,'subsection')
        })
    </script>
    <!-- //get section && subsection-->
{% endblock %}