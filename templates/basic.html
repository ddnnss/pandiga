{% load static %}
<!DOCTYPE html>
<!-- SKIBORG WAS HERE -->
<html lang="ru">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta charset="UTF-8">
    <title>index</title>

    <link rel="stylesheet" href="{% static 'css/font-awesome.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
<form style="display: none" id="dummy_form" >{% csrf_token %}</form>
{% include 'header.html' %}
{% block content %}
{% endblock %}
{% include 'footer.html' %}

{% block js %}
    <script>
     let csrfmiddlewaretoken = document.getElementsByName('csrfmiddlewaretoken')[0].value
      let cityId = document.getElementById('city_id')
       function openModal() {
            document.getElementsByClassName('modal')[0].classList.toggle('modal-active')
        }
    </script>
     <!-- getCities-->
    <script>
    function getCities(el) {
        let citySelectList = document.getElementById('city_select_list')

        if (el.value.length <= 2){
            console.log('too small')
             cityId.value = 'all'
            return
        }else{
            console.log(el.value)
            el.disabled = true
            let body = {'query':el.value}
            fetch('/get_city/', {
                method: 'post',
                body: JSON.stringify(body),
                headers: { "X-CSRFToken": csrfmiddlewaretoken },
                credentials: 'same-origin'
            }).then(res=>res.json())
                .then(res => {
                    console.log(res)
                    el.disabled = false
                    el.focus()
                    if (res.length >= 1){
                        citySelectList.innerHTML = ''
                        for(i of res){

                            citySelectList.innerHTML = citySelectList.innerHTML +
                                `<p data-id="${i['id']}" data-city="${i['city']}" data-region="${i['region']}" class="city-select-list-item" onclick="setCity(this)">
                                 ${i['city']}
                                 <span>${i['region']}</span>
                             </p>`
                        }
                        citySelectList.classList.add('list-active')
                    }else{
                        citySelectList.classList.remove('list-active')
                    }

                })
        }

    }
    function setCity(el) {
        let citySelectInput = document.getElementById('city_select_input')
        let citySelectList = document.getElementById('city_select_list')

        citySelectList.classList.remove('list-active')
        citySelectInput.value = `${el.dataset.region}, ${el.dataset.city}`
        cityId.value = el.dataset.id
    }
    </script>
    <!-- getCities-->
    <!-- get section && subsection-->
    <script>
        let typeSelect = document.getElementById('type_select')
        let sectionSelect = document.getElementById('section_select')
        let subsectionSelect = document.getElementById('subsection_select')

        function clearSelect(el){
            let elem = document.querySelectorAll(`.${el}`)
            elem.forEach(function (i) {
                console.log('Elem to clear:',i)
                i.remove()
            })
        }

        function createOption(name_slug,name,target,ro) {
            let option = document.createElement("option")
            option.text = name
            option.value = name_slug
            if (ro){
                option.setAttribute('disabled','disabled')
                option.setAttribute('selected','selected')
            }
            option.classList.add(`${target}-name`)
            return option

        }
        function getSubcat(name_slug,target) {
            let body = {'type':name_slug,'target':target}
            fetch('/catalog/get_type_sublists/', {
                method: 'post',
                body: JSON.stringify(body),
                headers: { "X-CSRFToken": csrfmiddlewaretoken },
                credentials: 'same-origin'
            }).then(res=>res.json())
                .then(res => {
                    console.log(res)
                    if (target === 'section'){
                       // sectionSelect.appendChild(createOption('all','Все разделы',target))
                        for (x of res) {
                            //console.log(x['id'])
                            sectionSelect.appendChild(createOption(x['name_slug'],x['name'],target))
                        }
                    }
                    if (target === 'subsection'){
                       // subsectionSelect.appendChild(createOption('all','Все подразделы',target))
                        for (x of res) {
                            //console.log(x['id'])
                            subsectionSelect.appendChild(createOption(x['name_slug'],x['name'],target))
                        }
                    }
                })
        }

        typeSelect.addEventListener('change',()=>{
            clearSelect('section-name')
            clearSelect('subsection-name')
            getSubcat(typeSelect.options[typeSelect.selectedIndex].value,'section')

        })
        sectionSelect.addEventListener('change',()=>{
            clearSelect('subsection-name')
            getSubcat(sectionSelect.options[sectionSelect.selectedIndex].value,'subsection')
        })
    </script>
    <!-- get section && subsection-->
{% endblock %}
</body>
</html>